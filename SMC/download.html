<!DOCTYPE html>
<html lang="en">

<head>
    <link href="style.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF with Tables</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</head>

<body>
<br>
<h1 class="text-center mb-4">Download PDF</h1>
<div class="container"
     style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column;">


    <button type="button" class="btn btn-primary" id="downloadPDF"
            style="font-size: 1.5rem; padding: 15px 30px;">Download PDF</button>
</div>
<script src="script.js"></script>

<script src="approvedImageData.js"></script>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabaseUrl = 'https://pgvllzvrngxokdxqyiwv.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBndmxsenZybmd4b2tkeHF5aXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1ODU4NjMsImV4cCI6MjA3MzE2MTg2M30.LKIOzN_8rFQKU-P0CaQMNftx3dTwSJc23AkiRROKdS4';

     const supabase = createClient(supabaseUrl, supabaseKey);

    let globalData = null;
    let fetched = false;


    document.getElementById("downloadPDF").addEventListener("click", () => {
        loadTableData().then(raw => {
            const dt = removeEmpty(raw);
            generatePDF(dt);
        });
    });

    async function loadTableData() {
        const { data, error } = await supabase
            .from('rttasmcteachers')
            .select('*');

        if (error || !data) {
            console.error("Supabase fetch failed:", error);
            return [];
        }

        globalData = data; // for checkData()
        fetched = true;


        const numberOfPeriods = 8;
        return data.map(t => {
            const periods = [];
            const subjects = [];
            for (let i = 0; i < numberOfPeriods; i++) {
                periods.push(t[`p${i + 1}_class`] || "-");
                subjects.push(t[`p${i + 1}_subject`] || "-");
            }
            return {
                name: t.name,
                periods,
                subjects
            };
        });
    }

    function removeEmpty(arr) {
        return arr.filter(row => {
            const teacher = globalData.find(t => t.name === row.name);
            if (!teacher) return false;

            for (let i = 1; i <= 8; i++) {
                if (teacher[`p${i}_status`] === "R") return true;
            }
            return false;
        });
    }


    function findRowIndexByName(name) {
        return globalData.findIndex(row => row.name === name);
    }

    function checkData(name) {
        const rowIndex = findRowIndexByName(name);
        if (rowIndex === -1) return ["0", ""];

        const row = globalData[rowIndex];
        if (!row || row.p1_class === "-") return ["0", ""];

        return ["1", row.p1_class, row.p1_subject];
    }

    function removeText(originalText, textToRemove) {
        return originalText.replaceAll(textToRemove, '');
    }

    function conl(_) {} // placeholder for logging

    function generatePDF(dt) {

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("l", "mm", "a4"); // Set orientation to landscape
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 10;
        const tableWidth = (pageWidth - (5 * margin)) / 4;
        const startY = 20;
        const tableHeight = 65;
        const totalPages = Math.ceil(dt.length / 8);
        let currentIndex = 0;

        for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
            let yOffset = startY;
            let xOffset = margin;

            if (pageNum > 1) doc.addPage();

            const centerY = pageHeight / 2;
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.line(0, centerY, pageWidth, centerY);

            const firstLineX = pageWidth / 4;
            const secondLineX = pageWidth / 2;
            const thirdLineX = (pageWidth / 4) * 3;
            doc.line(firstLineX, 0, firstLineX, pageHeight);
            doc.line(secondLineX, 0, secondLineX, pageHeight);
            doc.line(thirdLineX, 0, thirdLineX, pageHeight);

            for (let row = 0; row < 2; row++) {
                for (let col = 0; col < 4; col++) {
                    if (currentIndex < dt.length) {
                        const rw = dt[currentIndex];
                        const name = rw.name;
                        const today = getFormattedDate();
                        const tableData = [];

                        const teacherRecord = globalData.find(t => t.name === rw.name);
                        for (let i = 0; i < 8; i++) {
                            if (teacherRecord && teacherRecord[`p${i + 1}_status`] === "R") {
                                tableData.push([i + 1, rw.periods[i], rw.subjects[i]]);
                            }else{
                                tableData.push([i + 1,"-", "-"]);

                            }
                        }


                        if (row === 1 && col === 0) yOffset += 25;

                        doc.setFontSize(12);
                        doc.text(name, xOffset, yOffset - 8, { align: 'left' });
                        doc.setFontSize(9);
                        doc.text(today, xOffset, yOffset - 1, { align: 'left' });

                        const result = checkData(name);
                        if (result[0] === "1") {
                              }

                        doc.setFontSize(7);
                        doc.text("Software Donated By K.A.N.N.Sooriyabandara", xOffset, yOffset + tableHeight + 15, { align: 'left' });

                        if (waterMarkImage) {
                            doc.addImage(waterMarkImage, 'PNG', (xOffset + tableWidth / 2) - 30, (yOffset + tableHeight / 2) - 30, 60, 60);
                        }

                        doc.autoTable({
                            startY: yOffset,
                            head: [["#", "Class", "Subject"]],
                            body: tableData,
                            theme: "grid",
                            styles: {
                                fontSize: 8,
                                halign: 'center',
                                valign: 'middle',
                                lineColor: [0, 0, 0],
                                textColor: [0, 0, 0],
                                fillColor: false,
                                headerStyles: {
                                    textColor: [0, 0, 0],
                                    fillColor: [255, 255, 255],
                                    lineWidth: 0.5,
                                    lineColor: [0, 0, 0],
                                },
                            },
                            tableWidth: tableWidth,
                            margin: { left: xOffset },
                            columnStyles: {
                                0: { cellWidth: 10 }
                            }
                        });

                        currentIndex++;
                    }
                    xOffset += tableWidth + margin + 1;
                }
                yOffset += tableHeight + margin;
                xOffset = margin;
            }
        }

        doc.save("tables.pdf");
    }
    function getFormattedDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}/${month}/${day}`}

</script>

</body>

</html>