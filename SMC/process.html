<!DOCTYPE html>
<html lang="en">

<head>
    <link href="style.css" rel="stylesheet">
    <title>Relief time-table genarator</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-1.12.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">


    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background-color: #343a40;
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            margin-top: 1%;
            overflow-y: hidden;
        }

        .progress {
            height: 30px;
            /* Increased height */
        }

        .progress-bar {
            font-size: 1.5rem;
            /* Larger font size */
        }

        textarea {

        }

        #log {
            height: 100%;
            overflow-y: auto;
        }

        #logContainer {
            height: 40vh;
            font-size: 1.2rem !important;
            background: #181818 !important;
            border: 1px solid #333 !important;
            resize: none !important;
            border-radius: 8px !important;
            padding: 10px !important;
            width: 100% !important;
            font-family: monospace;
            overflow-y: auto; /* 🔥 Enables vertical scrolling */
        }


        @keyframes logFadeIn {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .log-entry {
            background: #202020;
            color: #ffffff;
            margin: 0;
            padding: 8px 12px;
            border-left: 4px solid #444;
            font-size: 1rem;
            font-family: monospace;
            transition: background 0.3s ease;
            white-space: pre-wrap;
            border-bottom: 1px solid #333;

            /* 🎬 Animation */
            animation: logFadeIn 0.4s ease-out;
        }



        .log-entry.success {
            border-left-color: #4caf50; /* Green for success/info */
        }

        .log-entry.none {
            border-left-color: rgba(100, 100, 100, 0); /* Green for success/info */

        }

        .log-entry.info {
            border-left-color: #5d5d5d; /* Green for success/info */
        }

        .log-entry.warn {
            border-left-color: #ff9800; /* Orange for warnings */
        }

        .log-entry.error {
            border-left-color: #f44336; /* Red for errors */
        }

        .log-entry.empty {
            text-align: center;
            background: rgba(68, 68, 68, 0);
            border-left-color: rgba(244, 67, 54, 0); /* Red for errors */
            border-bottom: 1px solid rgba(51, 51, 51, 0);
        }


    </style>
</head>

<body>

<div class="container">
    <div class="header-container" style="text-align: center;">
        <h1 style="text-align:center; position: relative; display: inline-block;">RTTA</h1>
        <h2 style="text-align:center;">Processor</h2>

    </div>

    <h4>Controls</h4>
    <button class="btn btn-primary btn-lg mb-4" id="butto" onclick="butto();">Process</button>

    <button class="btn btn-warning btn-lg mb-4" id="UploadBut" onclick="uploadToSupabase()" style="visibility: hidden;">
        Upload
    </button>

    <button onclick="generateReliefTableHTML(); window.open('view.html')" target="_blank"
            class="btn btn-success btn-lg mb-4" style="visibility: hidden;" id="ViewBut">View
    </button>

    <button onclick="window.open('download.html')" target="_blank" class="btn btn-primary btn-lg mb-4"
            style="visibility: hidden;" id="DownBut">Download
    </button>

    <h4>Progress</h4>
    <div class="progress mb-4">
        <div class="progress-bar bg-info" id="pro" role="progressbar" style="width: 0%" aria-valuenow="50"
             aria-valuemin="0" aria-valuemax="100">50%
        </div>
    </div>
    <br>
    <h4>Logs</h4>
    <div id="logContainer">
        <div id="log"></div>
    </div>

</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
<script src="script.js"></script>
<script type="module">
    import {createClient} from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://pgvllzvrngxokdxqyiwv.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBndmxsenZybmd4b2tkeHF5aXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1ODU4NjMsImV4cCI6MjA3MzE2MTg2M30.LKIOzN_8rFQKU-P0CaQMNftx3dTwSJc23AkiRROKdS4';

    const supabase = createClient(supabaseUrl, supabaseKey);

    function addLog(message, type = "none") {
        const logDiv = document.getElementById('log');
        if (!logDiv) return;

        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerHTML = `${message}`;
        logDiv.appendChild(entry);

        // Optional: Auto-scroll to latest log
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    window.butto = function () {
        const button = document.getElementById("butto");
        const progressBar = document.getElementById("pro");
        const viewButton = document.getElementById("ViewBut");
        const downloadButton = document.getElementById("DownBut");
        const uploadButton = document.getElementById("UploadBut");

        button.disabled = true;
        button.innerText = "...";
        addLog("Relief Assignment Process Started", 'info');

        let progress = 0;
        const interval = setInterval(() => {
            progress += 1;
            progressBar.style.width = `${progress}%`;
            progressBar.innerText = `${progress}%`;
            if (progress >= 100) {
                clearInterval(interval);


                // ________________________________________________________
                let startTime = new Date();

                assignReliefForExcludedPairs();
                assignReliefForAllAbsentTeachers();


                // ________________________________________________________
                let finishTime = new Date();
                const durationMs = finishTime - startTime;

                addLog(`Relief Assignment Process Ended (${durationMs}ms)`, 'success')
                addLog(
                    `<center><strong>Information Summary</strong></center><br>Total Absent Teachers : ${absentTeachers.length}<br>Total Periods Covered : ${actuallyCovered}/${shouldBeCovered} (${((actuallyCovered / shouldBeCovered) * 100).toFixed(2)}%)<br><br><strong>Assignment Breakdown</strong><br>\tExact Subject   : ${type1AssignmentCount}<br>\tCognate Subject : ${type2AssignmentCount}<br>\tClass Match     : ${type3AssignmentCount}<br>\tFallback Case   : ${type4AssignmentCount}`,
                    'warn'
                );
                addLog(``, "empty");

                button.innerText = "Processed";
                button.style.visibility = "hidden";
                button.style.display = "none";

                viewButton.style.visibility = "visible";

                uploadButton.style.visibility = "visible";
            }
        }, 30);
    };

    window.uploadToSupabase = async function () {
        const button = document.getElementById("UploadBut");
        const progressBar = document.getElementById("pro");
        const downloadButton = document.getElementById("DownBut");

        button.disabled = true;
        button.innerText = "Uploading...";
        addLog("Upload started", 'info');
        let startTime = new Date();

        let progress = 0;
        const interval = setInterval(() => {
            progress += 2;
            progressBar.style.width = `${progress}%`;
            progressBar.innerText = `${progress}%`;
            if (progress >= 100) {
                clearInterval(interval);
            }
        }, 30);

        // 🔥 Step 1: Delete all existing rows
        const {error: deleteError} = await supabase
            .from('rttasmcteachers')
            .delete()
            .neq('id', 0); // Deletes all rows (assuming no teacher has id 0)

        if (deleteError) {
            addLog("Delete failed", 'error');
            console.error(deleteError);
            button.innerText = "Retry Upload";
            button.disabled = false;
            return;
        }

        // ✅ Step 2: Prepare fresh data
        const payload = timeTable.map(t => {
            const data = {
                id: t.id,
                name: t.name,
                working: t.working
            };
            for (let i = 0; i < numberOfPeriods; i++) {
                data[`p${i + 1}_class`] = t.periods[i].class;
                data[`p${i + 1}_subject`] = t.periods[i].subject;
                data[`p${i + 1}_status`] = t.periodStatus[i];
            }
            return data;
        });

        // 🚀 Step 3: Upload fresh data
        const {error: uploadError} = await supabase
            .from('rttasmcteachers')
            .insert(payload);

        if (uploadError) {
            addLog("Upload Process Failed", 'erro');
            console.error(uploadError);
            button.innerText = "Retry Upload";
        } else {
            let finishTime = new Date();
            const durationMs = finishTime - startTime;
            addLog(`Upload Process Ended (${durationMs}ms)`, 'success');
            setTimeout(function () {
                addLog(``, "empty");
                addLog(
                    `Thank you for using <strong>RTTA</strong> (Relief Time Table Allocator)<br>
   <em>Software donated by K.A.N.N. Sooriyabandara</em><br>
   If you encounter any issues, please report them to the developer.`,
                    "info"
                );

            }, 2000);
            button.innerText = "Uploaded";
            button.style.visibility = "hidden";
            button.style.display = "none";
            downloadButton.style.visibility = "visible";
        }

        button.disabled = false;
    };


    window.generateReliefTableHTML = function () {
        let html = `<table id="myTable" class="table table-hover table-dark">
        <thead>
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Period 1</th>
                <th>Period 2</th>
                <th>Period 3</th>
                <th>Period 4</th>
                <th>Period 5</th>
                <th>Period 6</th>
                <th>Period 7</th>
                <th>Period 8</th>
            </tr>
        </thead>
        <tbody>`;

        timeTable.forEach(teacher => {
            html += `<tr>
            <td>${teacher.id}</td>
            <td>${teacher.name}</td>`;

            for (let i = 0; i < numberOfPeriods; i++) {
                if (teacher.periodStatus[i] === "R") {
                    const p = teacher.periods[i];
                    html += `<td>${p.class}<br>${p.subject}</td>`;
                } else {
                    html += `<td>-<br>-</td>`;
                }
            }

            html += `</tr>`;
        });

        html += `</tbody></table>`;
        localStorage.setItem("AB", html);
    };


    const exceptionStrings = ["-", "_", "PG", "Aesth", "PA345", "PE345", "12", "13", "EXCLUDE", "EXCLUDED"];
    const numberOfPeriods = 8;
    let absentTeachers = [];
    const ignoreSubjects = exceptionStrings;
    const ignoreClasses = exceptionStrings;
    const lockedTeachers = [81, 80, 146, 19];
    const subjectGroups = [
        ['Scie', 'Maths'],
        ['Sinha', 'Budd', 'History'],
        ['Drama', 'Dancing'],
        ['Music', 'WMusic', 'Art'],
        ['civcs', 'Geo', 'History']
        // Add more groups as needed
    ];


    let shouldBeCovered = 0;
    let actuallyCovered = 0;

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const rawAbsent = urlParams.get('absent');
    try {
        absentTeachers = JSON.parse(rawAbsent).map(Number);
    } catch (e) {
        console.error('Invalid absent parameter:', rawAbsent);
    }
    absentTeachers = removeDuplicates(absentTeachers);

    function removeDuplicates(arr) {
        return [...new Set(arr)];
    }


    let timeTable = [];

    formatTimeTables();

    function getExcludedPairsFromURL() {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get("exclude");
        if (!raw) return [];

        return raw.split(",").map(pair => {
            const [id, period] = pair.split(":");
            return [parseInt(id), parseInt(period)];
        });
    }

    function assignReliefForExcludedPairs() {
        const excludedPairs = getExcludedPairsFromURL(); // [[id, periodIndex], ...]

        excludedPairs.forEach(([teacherId, periodIndex]) => {
            periodIndex = periodIndex - 1;
            const teacher = timeTable.find(t => t.id === teacherId);
            if (!teacher) return;
            if (absentTeachers.includes(teacherId)) {
                console.warn(`Skipping excluded period for absent teacher ${teacher.name} (ID: ${teacherId})`);
                return false;

            }
            //console.log("vrw3tvw3tvw3vtvwt3vtw3vtwvtw4t");
            //console.log(teacher);
            const assigned = assignRelief(teacherId, periodIndex + 1); // +1 because assignRelief uses 1-based index
            if (assigned) {
                //console.log(`✅ Relief assigned for excluded period ${periodIndex + 1} of teacher ${teacher.name}`);
            } else {
                console.warn(`❌ No relief found for excluded period ${periodIndex + 1} of teacher ${teacher.name}`);
            }
            teacher.periods[periodIndex] = {class: "EXCLUDED", subject: "EXCLUDED"};
        });
    }


    function assignReliefForAllAbsentTeachers() {
        absentTeachers.forEach(teacherId => {
            const teacher = timeTable.find(t => t.id === teacherId);
            if (!teacher) return;

            for (let i = 1; i <= numberOfPeriods; i++) {

                const className = teacher.periods[i - 1].class;


                if (className === "") continue;

                const assigned = assignRelief(teacherId, i);

            }
        });
    }

    var type1AssignmentCount = 0;
    var type2AssignmentCount = 0;
    var type3AssignmentCount = 0;
    var type4AssignmentCount = 0;


    function assignRelief(teacherId, periodNumber) {
        let reliefAssignments = [];
        const teacher = timeTable.find(t => t.id === teacherId);
        if (!teacher) return false;

        const subjectNeeded = teacher.periods[periodNumber - 1].subject;
        const classNeeded = teacher.periods[periodNumber - 1].class;


        const shouldIgnoreSubject = ignoreSubjects.some(keyword =>
            subjectNeeded.toUpperCase().includes(keyword.toUpperCase())
        );
        const shouldIgnoreClass = ignoreClasses.some(keyword =>
            classNeeded.toUpperCase().includes(keyword.toUpperCase())
        );
        if (shouldIgnoreSubject || shouldIgnoreClass || classNeeded === "") {
            console.warn(`Relief skipped for period ${periodNumber} due to exclusion:`, {
                subject: subjectNeeded,
                class: classNeeded
            });
            return false;
        }
        const toBeAssignedID = teacher.id;

        const rawFreeTeachers = getFreeTeachers(periodNumber);
        const freeTeachers = rawFreeTeachers.filter(teacher =>
            teacher.id !== toBeAssignedID &&
            !lockedTeachers.includes(teacher.id)
        );


        const suitableTeachersBySubject = filterTeachersBySubject(subjectNeeded, freeTeachers);
        const suitableTeachersByGroups = filterTeachersBySubjectGroup(subjectNeeded, freeTeachers, subjectGroups);
        const suitableTeachersByClass = filterTeachersByClass(classNeeded, freeTeachers);
        const fallbackTeachers = getFallbackTeachers(freeTeachers);
        console.log(suitableTeachersByGroups);
        console.log(suitableTeachersBySubject.length + " : "+suitableTeachersByGroups.length);
        let suitableTeachers = [
            ...suitableTeachersBySubject,
            ...suitableTeachersByGroups,
            ...suitableTeachersByClass,
            ...fallbackTeachers
        ];

        const assignmentSources = [
            {array: suitableTeachersBySubject, type: 'type1'},
            {array: suitableTeachersByGroups, type: 'type2'},
            {array: suitableTeachersByClass, type: 'type3'},
            {array: fallbackTeachers, type: 'fallback'}
        ];

        for (const source of assignmentSources) {
            if (source.array.length > 0) {
                switch (source.type) {
                    case 'type1':
                        type1AssignmentCount++;
                        break;
                    case 'type2':
                        type2AssignmentCount++;
                        break;
                    case 'type3':
                        type3AssignmentCount++;
                        break;
                    case 'fallback':
                        type4AssignmentCount++;
                        break;
                }
                break; // Stop after the first non-empty array
            }
        }
        const uniqueById = {};
        suitableTeachers.forEach(t => uniqueById[t.id] = t);
        suitableTeachers = Object.values(uniqueById);

        shouldBeCovered++;
        if (suitableTeachers.length > 0) {
            const selectedTeacher = suitableTeachers[0];

            selectedTeacher.periods[periodNumber - 1].class = classNeeded;
            selectedTeacher.periods[periodNumber - 1].subject = subjectNeeded;
            selectedTeacher.periodStatus[periodNumber - 1] = "R";
            selectedTeacher.working++;
            actuallyCovered++;
            //console.log(`✅ Relief assigned to ${selectedTeacher.name} (ID: ${selectedTeacher.id})`);
            return true;
        } else {


            console.warn(`❌ No suitable teacher found for period ${periodNumber} of teacher ID ${teacherId}`);
            return false;
        }
    }

    function getFreeTeachers(periodNumber) {
        return timeTable.filter(teacher => {
            const period = teacher.periods[periodNumber - 1];
            const isFree = period.class === "-" || period.class === "";
            const isAbsent = absentTeachers.includes(teacher.id);
            const hasWork = teacher.working > 0 && teacher.working < 6;
            return isFree && !isAbsent && hasWork;
        });
    }

    function getFallbackTeachers(freeTeachers) {
        return freeTeachers.sort((a, b) => a.working - b.working); // Least busy first
    }

    function filterTeachersByClass(classNeeded, freeTeachers) {
        return freeTeachers
            .filter(teacher => teacher.periods.some(p => p.class === classNeeded))
            .sort((a, b) => a.working - b.working); // Least busy first
    }


    function filterTeachersBySubject(subjectNeeded, freeTeachers) {
        return freeTeachers
            .filter(teacher => teacher.periods.some(p => p.subject === subjectNeeded))
            .sort((a, b) => a.working - b.working);
    }

    function filterTeachersBySubjectGroup(subjectNeeded, freeTeachers, subjectGroups) {

        const matchedGroup = subjectGroups.find(group => group.includes(subjectNeeded));
        console.log("CALLED"+subjectNeeded+subjectGroups)
        if (!matchedGroup) return [];
        console.log("CALLED2")

        let matchingTeachers = [];
        for(const sub of matchedGroup){
            console.log("Group member: "+sub);
            matchingTeachers.push(...filterTeachersBySubject(sub, freeTeachers));
        }
        return matchingTeachers;
    }


    function formatTimeTables() {
        const raw = localStorage.getItem("sqlResult");
        if (!raw) return;
        try {
            const parsed = JSON.parse(raw);
            parsed.forEach(function (item) {
                let processedPeriods = [];
                let workingPeriods = 0;

                for (let i = 1; i <= numberOfPeriods; i++) {
                    const periodClass = item[`P${i} Class`];
                    const periodSubject = item[`P${i} Subject`];
                    if (periodClass !== '-') {
                        if (periodClass !== '') {
                            workingPeriods++;
                        }
                    }
                    processedPeriods.push({class: periodClass, subject: periodSubject});
                }
                let periodStatus = [];
                for (let i = 0; i < numberOfPeriods; i++) {
                    periodStatus.push("N");
                }

                const entry = {
                    id: item.ID,
                    name: item.Name,
                    periods: processedPeriods,
                    working: workingPeriods,
                    periodStatus: periodStatus
                };

                timeTable.push(entry);

            });

        } catch (e) {
            console.error('Failed to parse stored SQL result:', e);
            return [];
        }
    }
</script>


<script>

</script>
</html>