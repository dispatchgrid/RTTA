<!DOCTYPE html>
<html lang="en">

<head>
    <link href="style.css" rel="stylesheet">
    <title>Relief Time-table Generator</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://code.jquery.com/jquery-1.12.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #343a40;
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            margin-top: 1%;
            overflow-y: hidden;
        }

        .progress {
            height: 30px;
            /* Increased height */
        }

        .progress-bar {
            font-size: 1.5rem;
            /* Larger font size */
        }

        textarea {
            height: 40vh;

        }
    </style>
</head>

<body>
<div class="container">
    <h1 style="text-align:center;">RTTA</h1>
    <h2 style="text-align:center;" >Starting Application</h2>
    <p style="text-align:center;" >Software Donated By K.A.N.N.Sooriyabandara</p>


    <!-- Progress Bar -->
    <div class="progress mb-4">
        <div class="progress-bar" id="pro" role="progressbar" style="width: 0%" aria-valuenow="0"
             aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <br>
    <br>
    <!-- Text container -->
    <div id="progressText" class="text-center font-weight-bold">Starting...</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://pgvllzvrngxokdxqyiwv.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBndmxsenZybmd4b2tkeHF5aXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1ODU4NjMsImV4cCI6MjA3MzE2MTg2M30.LKIOzN_8rFQKU-P0CaQMNftx3dTwSJc23AkiRROKdS4';
    const supabase = createClient(supabaseUrl, supabaseKey);




    let progressBar = document.getElementById('pro');
    let progressText = document.getElementById('progressText');
    let currentProgress = 0;
    let serversFetched = false;
    let resolvedDay = "Monday";
    function updateProgressBar() {
        if (currentProgress < 90) {
            currentProgress += 10;

            if (currentProgress <= 30) {
                progressText.innerHTML = 'Caching...';
            } else if (currentProgress <= 60) {
                progressText.innerHTML = 'Updating...';
            } else if (currentProgress <= 90) {
                progressText.innerHTML = 'Waking up the servers...';
                fetchData();
            }

            progressBar.style.width = currentProgress + '%';
            progressBar.setAttribute('aria-valuenow', currentProgress);
            progressBar.innerHTML = currentProgress + '%';

            setTimeout(updateProgressBar, 500); // Simulate delay for each step
        } else if (serversFetched) {
            currentProgress = 100;
            progressText.innerHTML = 'Building UI...';
            progressBar.style.width = '100%';
            progressBar.setAttribute('aria-valuenow', 100);
            progressBar.innerHTML = '100%';

            setTimeout(function () {

                window.location.href = "submit.html";

            }, 5000);
        }
    }

    function fetchData() {

        console.log("Resolved day:", resolvedDay);
        fetchAndStoreRTTAMain(resolvedDay);

        serversFetched = true;

    }
    async function fetchAndStoreRTTAMain(resolvedDay, storageKey = 'sqlResult') {
        if (!resolvedDay || typeof resolvedDay !== 'string') {
            throw new Error('resolvedDay must be a non-empty string');
        }

        const { data, error } = await supabase
            .from('rttasmcmain')
            .select('*')
            .eq('Date', resolvedDay);

        if (error) {
            console.error('Supabase Error:', error.message);
            document.getElementById('output').textContent = 'Error: ' + error.message;
            return null;
        }

        localStorage.setItem(storageKey, JSON.stringify(data));
        document.getElementById('output').textContent = JSON.stringify(data, null, 2);
        return data;
    }
    var code = prompt("Enter the password to continue:")
    if(code === "admin") {
        setTimeout(updateProgressBar, 2000);
        const today = new Date();
        const currentDayIndex = today.getDay(); // 0 = Sunday, 6 = Saturday
        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const todayName = dayNames[currentDayIndex];

        resolvedDay = todayName;

        if (currentDayIndex === 0 || currentDayIndex === 6) {
            const input = prompt("It's the weekend! Enter a day (e.g., Monday):","Monday");

            if (!input || input.trim() === "") {
                resolvedDay = "Monday";
            } else {
                const formatted = input.trim().toLowerCase();
                const match = dayNames.find(day => day.toLowerCase() === formatted);

                resolvedDay = match || "Invalid day";
            }
        }

    }else if(code === "edit"){
        window.location.href = "admin.html";
    }else{
        alert("Incorrect password");
        window.location.href = "index.html";
    }
</script>
</body>
</html>
